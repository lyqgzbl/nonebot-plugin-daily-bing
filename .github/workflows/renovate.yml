name: Renovate Self-Hosteds

on:
  schedule:
    - cron: '0 0 * * MON' 
  workflow_dispatch: 

env:
  RENOVATE_PLATFORM: 'github'
  LOG_LEVEL: 'info' 
  RENOVATE_ALLOWED_COMMANDS: '["^(uv lock)$"]'

jobs:
  renovate:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: ⬇️ Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.RENOVATE_TOKEN }}

      - name : 🔨 Build Custom Renovate Image
        id: build_image
        run: |
          IMAGE_NAME="renovate-with-uv"
          docker build -t $IMAGE_NAME .
          echo "IMAGE_NAME=$IMAGE_NAME" >> $GITHUB_ENV

      - name: 👤 Setup Git Identity
        run: |
          git config --global user.email "renovate[bot]@users.noreply.github.com"
          git config --global user.name "Renovate Bot"

      - name: 🚀 Run Renovate Self-Hosted
        run: |
          docker run \
            --rm \
            --user "$(id -u):$(id -g)" \
            -e RENOVATE_TOKEN="${{ secrets.RENOVATE_TOKEN }}" \
            -e RENOVATE_PLATFORM="${{ env.RENOVATE_PLATFORM }}" \
            -e LOG_LEVEL="${{ env.LOG_LEVEL }}" \
            -e RENOVATE_ALLOWED_COMMANDS='${{ env.RENOVATE_ALLOWED_COMMANDS }}' \
            -v "$PWD:/usr/app/repo" \
            "${{ env.IMAGE_NAME }}" \
            --base-dir /usr/app/repo \
            --cache-dir /tmp/renovate \
            --repositories "${{ github.repository }}"